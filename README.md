# WebRTC 연습 코드

### WebRTC란?

- Web Real-Time Communication
- 중간자 없이 브라우저 간 오디오나 미디어를 포착하고 스트리밍, 데이터 교환을 할 수 있도록 하는 기술
- 종단 간 데이터 공유, 화상 회의를 가능하게 한다.
- P2P 방식으로 피어간 데이터 교환을 한다.

### P2P, Peer to Peer

- 동등(peer) 계층간 통신망
- 중앙 서버를 거치치 않고 클라이언트 끼리(동등 계층 끼리) 직접 통신하는 방식
- WebRTC는 P2P방식을 따르므로 각각의 웹 브라우저는 아래의 절차로 진행된다
  1. 각 브라우저가 P2P커뮤니케이션에 동의한다.
  2. 서로의 주소를 공유한다.
  3. 보안 사항 및 방화벽 우회한다.
  4. 멀티미디어 데이터를 실시간 교환한다.
- 브라우저는 웹 서버가 아니므로, 외부에서 접근할 수 있는 정보(주소)가 없기때문에 일반적인 방법으로 2, 3번의 단계는 해결하기 어렵다.
- 따라서 P2P라고 하더라도 서버가 필요하다.

### 방화벽, NAT 트래버셜

- 일반적인 컴퓨터에는 방화벽, NAT, DHCP 등의 이유로 공인 IP를 알아낸다고 하더라도 특정 사용자를 가리킬 수 없고, 공인 IP, 사설 IP 주소 모두 알아야 특정한 사용자를 지목할 수 있다.

```
💡 NAT : 다수의 private IP를 public IP변경에 필요한 주소 변환 서비스

💡 DHCP : IP주소와 게이트웨이 또는 네임 서버의 주소 정보를 자동으로 할당해주는 프로토콜
```

- 일반 가정에서 컴퓨터를 사용할 때 라우터가 NAT역할(public IP, port를 확인하여 현재 네트워크 내 private IP를 매핑)을 한다. 따라서 브라우저가 직접 통신하기 위해, 각자 연결된 라우터의 public IP와 포트를 먼저 알아내야 한다.
- 어떤 라우터들은 특정 IP, port와 연결을 차단하는 방화벽 설정이 되어 있을 수 있다. 여기서 라우터를 통과하여 연결할 방법을 찾는 것을 NAT 트래버셜(NAT traversal) 이라고 한다.

### STUN, TURN

##### STUN, Session Traversal Utilities for NAT

- NAT 트래버셜 작업은 STUN 서버에 의하여 이루어지며, STUN 방식은 단말이 자신의 공인 IP 주소와 포트를 확인하는 과정에 대한 프로토콜이다.
- STUN서버는 유일하게 식별할 수 있는 정보를 반환하며, WebRTC 연결 시작 전 STUN 서버로 요청을 보내면, STUN 서버는 NAT 뒤의 peer가 서로 연결할 수 있도록 IP와 포트를 찾아준다.
- 어떤 라우터는 방화벽 정책을 다르게 하여 접근을 막거나, 이전에 연결된 적이 있는 네트워크만 연결할 수 있게 제한(Symmetric NAT)을 걸기도 한다. 그래서 STUN 서버를 통해 자신의 주소를 찾지 못한 경우 TURN서버를 대안으로 이용하게 된다.

##### TURN

- 네트워크 미디어를 중개하는 서버를 이용하는 방식이다.
- TURN 방식은 중간 서버가 존재하므로 P2P 방식에서 벗어나게 되며, latency가 발생한다.
- 하지만 보안이 엄격한 NAT 내부의 브라우저와 P2P 통신을 할 수 있는 유일한 방법이므로 TURN은 최후의 수단으로 선택하도록 한다.

### ICE, Candidate

- Candidate : STUN, TURN 서버를 이용하여 획득한 IP, 프로토콜, 포트의 조합으로 구성된 연결 가능한 네트워크 주소의 후보
- 이러한 후보들을 찾는 과정을 Finding Candidate라고 한다.
- Candidate를 수집하면 3개의 주소를 얻게 된다.
  - 자신의 private IP와 포트 넘버
  - 자신의 public IP와 포트 넘버 (STUN, TURN 서버로 부터 획득)
  - TURN 서버의 IP와 포트 넘버 (TURN 서버로 부터 획득)
- ICE
  - 두 개의 단말이 P2P 연결을 가능하도록, 최적의 경로를 찾아주는 프레임워크
  - STUN 또는 TURN 서버를 이용하여 상대방과 연결 가능한 후보들을 갖고 있다.

### SDP, Session Description Protocol

- WebRTC에서 스트리밍 미디어의 해상도나 형식, 코덱 등의 멀티미디어 컨텐츠의 초기 인수를 설명하기 위해 채택한 프로토콜이다. (미디어와 관련된 초기 세팅 정보를 기술한다.)
- 비디오 해상도, 오디오 전송 또는 수신 여부를 보낼 수 있다.
- 발행 구독 모델(Pub / Sub)과 유가한 제안 응답 모델(Offer / Answer)를 가지고 있다.
  1. 어떤 Peer가 이러한 미디어 스트림을 교환할 것이라고 제안을 하면, 상대방으로부터 응답이 오기를 기다린다.
  2. 응답을 받게 되면 각자의 Peer가 수집한 ICE 후보 중 최적의 경로를 결정하고 협상하는 프로세스가 발생한다.
  3. 최적의 ICE 후보가 선택되면, 기본적으로 필요한 모든 메타 데이터와 IP주소 및 포트, 미디어 정보가 Peer간의 합의가 완료된다.
  4. P2P 연결이 완전히 설정되고 활성화 되며, 각 Peer에 의하여 로컬 데이터 스트림의 엔드포인트가 생성되며, 이 데이터는 양방향 통신 기술을 사용하여 최종적으로 양방향으로 전송된다.
- 위 과정에서 NAT의 보안 이슈 등으로 최선의 ICE 후보를 찾지 못할 수 도 있으므로, 이때 폴백으로 세팅한 TURN 서버를 P2P 대용으로 설정하도록 한다.

### Trickle ICE

- 일반적인 방식의 ICE 후보 수집 작업은 몇 가지 문제가 있다.
  - 각 Peer는 ICE 후보들을 수집하여 그 목록을 완성한 후 한꺼번에 교환하게 된다.
  - 후보를 모으는 데에도 시간이 걸리고 네트워크 환경에 따라 latency가 발생할 수 있다.
  - 한쪽 ICE 후보 수집이 완료 되어야만 다른 Peer가 ICE 후보를 모을 수 있으므로 비효율적이다.
- 위의 문제점을 해결해 줄 수 있는 것은 **Trickle ICE** 이다.
  - 2개의 Peer가 ICE 후보를 수집하고 교환하는 과정을, 동기적 프로세스에서 비동기적 프로세스로 만드는 기술이다.
  - Trickle 옵션이 활성화된 ICE 프레임워크는 각 Peer에서 ICE 후보를 찾아내는 즉시 교환을 시작하며, 이 방식은 상호 간 연결이 가능한 ICE를 보다 빨리 찾아낼 수 있다.
- Trickle ICE 옵션을 사용한다면 Peer간 연결 상태를 체크함과 동시에 연결에 걸리는 시간을 최적화 할 수 있다. 따라서 Trickle 옵션은 가능하다면 활성화 하는 것이 좋다.

### 시그널링

- 위에서 기술한 모든 과정을 일컬어 시그널링 이라고 한다.
  - RTCPeerConnection 통신에 사용할 프로토콜, 채널, 미디어 코덱 및 형식, 데이터 전송 방법
  - 라우팅 정보와 NAT 통과 방법을 포함한 통신 규격을 교환하기 위한 두 장치의 제어 정보 교환
- 시그널링은 WebRTC의 자체 스팩이 아닌 연결 전 미리 준비해야 하는 과정이다.
- Peer가 언제 어떤 방식으로 연결될 수 있는지의 모든 경우를 예측할 수 없으므로, 정해져 있는 방법은 아니다.
- 따라서, 일반적으로 2개의 장치를 연결할 수 있는 시그널링 서버를 직접 구축하거나, 서드파티 솔루션을 이용할 수 있다.
  - 직접 서버를 구축한다면 웹 소켓, 서버 전송 이벤트, 폴링 방법 등으로 구현할 수 있다.
  - 서드파티 솔루션을 이용한다면 구글의 AppRTC, 아마존의 Kinesis Video Stream 등이 있다.
